import { useState, useEffect } from "react";
import { useAccount } from "wagmi";
import { ConnectKitButton } from "connectkit";
import ChainSelector from "../buttons/ChainSelector";
import hypercycle from "hypercyclejs";
import { formatUnits } from "viem";
import { useChat } from "../../context/ChatContext";
import DialogDemo from "./Dialog";

interface IBalance { [address: string]: { HYPC: bigint, USDC: bigint } }

interface BalanceDisplayProps {
  currency: string;
}

const BalanceDisplay = ({ currency }: BalanceDisplayProps) => {
  const { isLoading } = useChat();
  const { address } = useAccount();
  const [currentBalance, setCurrentBalance] = useState<IBalance | undefined>();

  useEffect(() => {
    const getNodeBalance = async (node: string, userAddress: string) => {
      try {
        const balance = await hypercycle.getNodeBalance(
          node,
          userAddress,
          "ethereum"
        );
        console.log("balance", balance);
        setCurrentBalance(balance);
      } catch (error) {
        console.log(error);
      }
    };

    getNodeBalance(
      import.meta.env.VITE_NODE_URL,
      address!
    );

  }, [address, isLoading]);

  return (
    <div className="rounded-xl flex items-center justify-center text-white bg-slate-900 border-1 border-slate-700 px-2 py-1">      
      {currentBalance && address && Object.keys(currentBalance[address]).map((key) => {
        const balance = currentBalance[address][key as keyof typeof currentBalance[typeof address]];
        if (currency !== key) return null;
        return (
          <span key={key} className="py-1 px-2 font-semibold  text-left">
            {key}: {formatUnits(balance, 6)}
          </span>
        );
      })}
    </div>
  );
}


const LLamaIcon = () => (
  <svg className="w-8 h-8 text-white" width="1024" height="1024" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
  <path d="M418.902 238.361C419.512 241.86 421.376 258.173 423.044 274.611C426.377 307.442 426.854 311.214 430.591 334.28C431.997 342.958 433.001 350.444 432.823 350.915C432.646 351.385 426.2 356.84 418.5 363.037C401.369 376.824 383.527 392.053 363.027 410.386C354.487 418.023 336.736 433.323 323.579 444.386C300.11 464.12 260.571 498.08 246.25 510.804C239.651 516.667 239 517.026 239 514.801C239 513.456 239.668 510.364 240.485 507.928C241.302 505.493 244.2 492.7 246.926 479.5C257.519 428.195 276.889 337.675 278.757 330.744L279.5 327.987L291.343 337.465L303.186 346.943L308.343 343.625C311.179 341.8 326.325 331.414 342 320.545C357.675 309.676 372.898 299.419 375.828 297.752C382.08 294.195 381.271 295.393 401.505 259.75C410.169 244.488 417.379 232 417.526 232C417.674 232 418.293 234.863 418.902 238.361Z" />
  <path fillRule="evenodd" clipRule="evenodd" d="M373.781 91.5C377.138 96.45 384.367 106.114 389.847 112.976L399.81 125.452L400.997 134.976C401.65 140.214 403.701 155.075 405.555 168L408.925 191.5L401.03 207C396.688 215.525 386.637 234.2 378.695 248.5L364.254 274.5L355.79 280.5C351.134 283.8 338.053 293.137 326.719 301.25C315.386 309.362 305.674 316 305.137 316C304.601 316 297.038 311.238 288.331 305.417C279.624 299.597 269.8 293.239 266.5 291.29L260.5 287.745L229.149 286.938C211.906 286.494 197.709 285.989 197.601 285.816C197.36 285.428 195.233 280.628 193.352 276.225C191.975 273.004 191.992 272.96 194.34 273.549C196.107 273.993 200.533 272.156 211.364 266.487C219.414 262.273 226 258.459 226 258.011C226 257.564 218.415 256.873 209.144 256.477L192.287 255.757L190.613 252.921L188.938 250.086L204.598 231.793L220.258 213.5L247.879 205.751C295.492 192.394 305.808 189.89 315.715 189.29L324.931 188.731L344.572 199.425C355.375 205.307 364.424 209.909 364.681 209.653C365.522 208.811 365.52 107.872 364.679 92.525C363.732 75.259 362.837 75.36 373.781 91.5ZM298.051 246C297.06 246 285.533 229.781 280.023 220.635L277.695 216.77L282.597 217.367C285.294 217.695 295.15 218.66 304.5 219.511C313.85 220.361 322.824 221.324 324.443 221.65L327.386 222.244L324.443 224.368C322.824 225.537 316.388 230.882 310.14 236.247C303.892 241.611 298.452 246 298.051 246Z" />
  <path d="M328.006 96.697C330.929 101.481 335.948 108.22 339.16 111.672L345 117.95V145.45V172.95L342.75 172.08C341.512 171.601 336.956 169.587 332.625 167.605C328.294 165.622 323.834 164 322.715 164C320.703 164 320.687 163.699 321.34 138.338C321.703 124.224 322 107.124 322 100.338C322 93.552 322.155 88 322.345 88C322.535 88 325.082 91.914 328.006 96.697Z" />
  <path d="M433.788 415.501C433.537 444.741 433.691 449.001 435 448.999C435.825 448.998 450 447.888 466.5 446.532C483 445.176 506.175 443.362 518 442.499C552.003 440.02 625.05 434.071 630 433.378L634.5 432.748L620.98 446.624C613.544 454.256 579.328 489.3 544.944 524.5C510.561 559.7 480.05 591.053 477.141 594.174L471.853 599.849L473.495 610.674C474.398 616.628 476.747 629.6 478.715 639.5C481.046 651.226 482.312 660.463 482.347 666C482.397 674.046 476.731 708.664 449.246 868.25L445.5 889.999L420.191 890C400.21 890 395.04 889.737 395.633 888.75C396.045 888.063 402.663 877.6 410.338 865.5L424.294 843.5L418.557 811.5C415.402 793.9 409.466 760.602 405.365 737.505C401.265 714.407 397.592 695.237 397.205 694.904C396.817 694.57 385.484 684.893 372.02 673.399C358.556 661.904 344.864 649.989 341.594 646.92C335.928 641.602 335.72 641.238 337.165 639.175C340.556 634.333 358.331 615.474 394.662 578.172C427.84 544.106 433.106 538.285 434.021 534.672C434.602 532.377 438.727 520.255 443.188 507.733C447.649 495.211 451.069 484.736 450.789 484.455C450.508 484.175 444.768 490.064 438.034 497.544C431.299 505.023 418.299 518.894 409.145 528.367C399.99 537.84 377.796 561.095 359.825 580.045C320.08 621.955 313.282 628.72 312.185 627.462C311.723 626.933 299.272 611.2 284.514 592.5C269.757 573.8 254.791 554.9 251.257 550.501L244.831 542.502L249.665 538.192C262.188 527.028 281.493 510.581 291 502.976C296.775 498.357 308.25 488.693 316.5 481.499C324.75 474.306 351.75 451.14 376.5 430.02C401.25 408.9 423.975 389.471 427 386.846C430.025 384.22 432.855 382.056 433.288 382.036C433.722 382.016 433.947 397.075 433.788 415.501Z" />
  <path d="M348.518 694.5C362.16 709.35 374.201 722.483 375.274 723.684L377.225 725.869L372.212 734.684C352.522 769.305 309.83 849.03 296.673 875.75L289.657 890H270.328C259.698 890 251 889.778 251 889.506C251 889.235 257.624 878.547 265.721 865.756C273.817 852.965 281.2 840.25 282.127 837.5C284.115 831.603 289.488 808.441 298.016 769C301.405 753.325 307.738 724.387 312.089 704.693C316.44 684.999 320 667.687 320 666.221C320 663.583 320.019 663.576 321.856 665.528C322.877 666.612 334.875 679.65 348.518 694.5Z" />
  <path d="M551.097 594.177C576.675 626.771 582.186 634.224 581.299 635.012C580.859 635.402 574.875 636.738 568 637.981C561.125 639.224 545.733 642.661 533.796 645.62C521.859 648.579 510.321 651 508.155 651H504.217L502.124 639.75C500.973 633.563 499.274 623.854 498.35 618.176L496.669 607.852L514.574 589.926C524.422 580.067 532.753 572 533.087 572C533.421 572 541.526 581.98 551.097 594.177Z" />
  <path d="M689 445.765C700.825 450.702 721.3 458.868 734.5 463.913C747.7 468.957 762.664 474.676 767.754 476.622C776.15 479.83 777.228 480.546 779.373 484.329C790.608 504.15 801.449 522.361 807.674 531.873L815.118 543.247L813.547 547.174C811.236 552.95 783.907 601.185 781.414 603.889C779.626 605.828 775.678 573.572 774.33 546C773.692 532.971 773.574 532.411 770.935 529.943C767.589 526.813 746.871 511.795 746.465 512.205C746.156 512.518 746.238 513.364 750.941 558.5C752.602 574.45 754.661 596.05 755.516 606.5C756.371 616.95 758.215 636.525 759.614 650C762.586 678.623 759.438 671.429 785.857 709.961C795.843 724.524 804 737.409 804 738.618C804 740.93 801.068 761.423 796.076 794C790.158 832.624 784.479 881.646 785.394 886.22L785.95 889H756.493H727.036L741.49 868.497L755.944 847.994L753.53 820.247C752.202 804.986 750.594 785.525 749.957 777C749.319 768.475 748.506 760.061 748.149 758.302C747.567 755.436 743.875 752.597 712.5 730.896C663.254 696.835 662.023 696 661.05 696C659.908 696 642.207 673.796 618.002 642C607.325 627.975 590.452 606.15 580.507 593.5C570.562 580.85 559.607 566.785 556.163 562.244L549.9 553.987L591.674 510.744C652.786 447.48 664.625 435.639 666.155 436.252C666.895 436.548 677.175 440.829 689 445.765Z" />
  <path d="M602.491 687.431C605.237 689.669 616.262 699.166 626.991 708.536C647.764 726.677 667.09 743.114 677.893 751.83C681.527 754.762 684.618 757.478 684.762 757.866C685.087 758.742 682.637 762.411 664.981 787.5C657.239 798.5 638.035 826.063 622.304 848.75L593.702 890H572.283H550.864L552.801 887.25C555.22 883.815 626.348 770.088 627.953 767.087C628.972 765.184 628.53 763.872 624.626 757.197C622.151 752.963 617.81 744.325 614.98 738C612.151 731.675 605.576 717.204 600.37 705.843C595.164 694.481 590.624 683.456 590.281 681.343L589.657 677.501L593.579 680.432C595.735 682.044 599.746 685.193 602.491 687.431Z" />
  </svg>
)

const Navbar = () => {

  const { address } = useAccount();
  return (
    <div className="w-full bg-slate-900 px-6 sm:px-20">
      <div className="mx-auto max-w-[1216px] flex items-center justify-between py-2 sm:py-3 text-slate-100">
        {/* Brand/Logo */}

        <div className="flex items-center gap-2">
          <LLamaIcon />
           <div className="text-lg font-semibold">OllamaAim</div>
        </div>

        {/* Controls: Chain Selector & Connect Wallet */}
        <div className="flex items-center gap-4">

          { address && <DialogDemo/>}
          
          {/* Balance Display */}
          { address && <BalanceDisplay currency="USDC" />}

          {/* Balance Display */}
          
          {/* Connect Wallet Button */}
          <ConnectKitButton.Custom>
            {({
              isConnected,
              show,
              ensName,
              truncatedAddress,
            }) => (
              <button
                onClick={show}
                className="w-fit hover:bg-slate-700 cursor-pointer transition-all duration-200  rounded-xl 
                border border-slate-800 bg-slate-900
                px-2 py-2 font-bold text-slate-100"
              >
                {isConnected
                  ? ensName ?? truncatedAddress
                  : "Connect Wallet"}
              </button>
            )}
          </ConnectKitButton.Custom>

          {/* Chain Selector */}
          <ChainSelector />
          
        </div>
      </div>
    </div>
  );
};

export default Navbar;
